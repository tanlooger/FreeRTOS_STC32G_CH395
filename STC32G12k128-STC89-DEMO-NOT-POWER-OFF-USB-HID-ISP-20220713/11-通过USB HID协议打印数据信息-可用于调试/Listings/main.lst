C251 COMPILER V5.60.0,  main                                                               09/07/22  14:01:57  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE main
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C251\BIN\C251.EXE main.c XSMALL INTR2 BROWSE DEBUG PRINT(.\Listings\main.lst) OBJECT(.\O
                    -bjects\main.obj) 

stmt  level    source

    1          /*---------------------------------------------------------------------*/
    2          /* --- STC MCU Limited ------------------------------------------------*/
    3          /* --- STC 1T Series MCU Demo Programme -------------------------------*/
    4          /* --- Mobile: (86)13922805190 ----------------------------------------*/
    5          /* --- Fax: 86-0513-55012956,55012947,55012969 ------------------------*/
    6          /* --- Tel: 86-0513-55012928,55012929,55012966 ------------------------*/
    7          /* --- Web: www.STCMCU.com --------------------------------------------*/
    8          /* --- Web: www.STCMCUDATA.com  ---------------------------------------*/
    9          /* --- QQ:  800003751 -------------------------------------------------*/
   10          /* 如果要在程序中使用此代码,请在程序中注明使用了STC的资料及程序            */
   11          /*---------------------------------------------------------------------*/
   12          
   13          /*************  功能说明    **************
   14          
   15          本例程基于STC32G转STC89系列转接板（降龙棍）进行编写测试。
   16          
   17          P3.2口按键演示"ShowLong"函数输出长整型数据;
   18          
   19          P3.3口按键演示"ShowFloat"函数输出浮点数数据;
   20          
   21          P5.4(RST)口按键演示"ShowCode"函数输出8字节数组数据;
   22          
   23          此外程序演示两种复位进入USB下载模式的方法：
   24          1. 通过每1毫秒执行一次“KeyResetScan”函数，实现长按P3.2口按键触发MCU复位，进入USB下载模式。
   25          2. 通过加载“stc_usb_hid_32g.lib”库函数，实现使用STC-ISP软件发送指令触发MCU复位，进入USB下载模式并自动下
             -载。
   26          
   27          下载时, 选择时钟 24MHZ (用户可自行修改频率)。
   28          
   29          ******************************************/
   30          
   31          #include "../comm/STC32G.h"  //包含此头文件后，不需要再包含"reg51.h"头文件
   32          #include "../comm/usb.h"     //USB调试及复位所需头文件
   33          #include "intrins.h"
   34          
   35          /****************************** 用户定义宏 ***********************************/
   36          
   37          #define MAIN_Fosc       24000000L   //定义主时钟
   38          
   39          /*****************************************************************************/
   40          
   41          //USB调试及复位所需定义
   42          char *USER_DEVICEDESC = NULL;
   43          char *USER_PRODUCTDESC = NULL;
   44          char *USER_STCISPCMD = "@STCISP#";                      //设置自动复位到ISP区的用户接口命令
   45          
   46          //P3.2口按键复位所需变量
   47          bit Key_Flag;
   48          u16 Key_cnt;
   49          
   50          u8 xdata cod[8];
   51          
   52          void delay_ms(u8 ms);
   53          void KeyResetScan(void);
   54          
   55          /******************** 主函数 **************************/
   56          void main(void)
   57          {
C251 COMPILER V5.60.0,  main                                                               09/07/22  14:01:57  PAGE 2   

   58   1          WTST = 0;  //设置程序指令延时参数，赋值为0可将CPU执行指令的速度设置为最快
   59   1          EAXFR = 1; //扩展寄存器(XFR)访问使能
   60   1          CKCON = 0; //提高访问XRAM速度
   61   1      
   62   1          P0M1 = 0x00;   P0M0 = 0x00;   //设置为准双向口
   63   1          P1M1 = 0x00;   P1M0 = 0x00;   //设置为准双向口
   64   1          P2M1 = 0x00;   P2M0 = 0x00;   //设置为准双向口
   65   1          P3M1 = 0x00;   P3M0 = 0x00;   //设置为准双向口
   66   1          P4M1 = 0x00;   P4M0 = 0x00;   //设置为准双向口
   67   1          P5M1 = 0x00;   P5M0 = 0x00;   //设置为准双向口
   68   1          P6M1 = 0x00;   P6M0 = 0x00;   //设置为准双向口
   69   1          P7M1 = 0x00;   P7M0 = 0x00;   //设置为准双向口
   70   1      
   71   1          //USB调试及复位所需代码-----
   72   1          P3M0 &= ~0x03;
   73   1          P3M1 |= 0x03;
   74   1          IRC48MCR = 0x80;
   75   1          while (!(IRC48MCR & 0x01));
   76   1          usb_init();
   77   1          //-------------------------
   78   1      
   79   1          EUSB = 1;   //IE2相关的中断使能后，需要重新设置EUSB
   80   1          EA = 1;     //打开总中断
   81   1      
   82   1          while (1)
   83   1          {
   84   2              delay_ms(1);
   85   2              if (bUsbOutReady)
   86   2              {
   87   3      //            memcpy(UsbInBuffer,UsbOutBuffer,64);  //接收数据存放发送缓冲区
   88   3      //            usb_IN();  //原样返回接收数据，用于测试
   89   3                  
   90   3                  usb_OUT_done(); //接收应答（固定格式）
   91   3              }
   92   2      
   93   2              KeyResetScan();   //长按P3.2口按键触发软件复位，进入USB下载模式，不需要此功能可删除本行代码
   94   2              
   95   2              if (!P32)
   96   2              {
   97   3                  while (!P32);
   98   3                  SEG7_ShowLong(0x98765432, 16);  //输出数码管长整型数据
   99   3              }
  100   2              else if (!P33)
  101   2              {
  102   3                  while (!P33);
  103   3                  SEG7_ShowFloat(3.1415);  //输出数码管浮点数数据
  104   3              }
  105   2              else if (!P54)
  106   2              {
  107   3                  cod[0] = 0x3f;  //数码管段码
  108   3                  cod[1] = 0x06;
  109   3                  cod[2] = 0x5b;
  110   3                  cod[3] = 0x4f;
  111   3                  cod[4] = 0x66;
  112   3                  cod[5] = 0x6d;
  113   3                  cod[6] = 0x7d;
  114   3                  cod[7] = 0x27;
  115   3                  while (!P54);
  116   3                  SEG7_ShowCode(cod);  //输出数码管码值
  117   3              }
  118   2          }
  119   1      }
  120          
  121          //========================================================================
  122          // 函数: void delay_ms(u8 ms)
  123          // 描述: 延时函数。
C251 COMPILER V5.60.0,  main                                                               09/07/22  14:01:57  PAGE 3   

  124          // 参数: ms,要延时的ms数, 这里只支持1~255ms. 自动适应主时钟.
  125          // 返回: none.
  126          // 版本: VER1.0
  127          // 日期: 2021-3-9
  128          // 备注: 
  129          //========================================================================
  130          void delay_ms(u8 ms)
  131          {
  132   1           u16 i;
  133   1           do{
  134   2                i = MAIN_Fosc / 6000;
  135   2                while(--i);   //6T per loop
  136   2           }while(--ms);
  137   1      }
  138          
  139          //========================================================================
  140          // 函数: void KeyResetScan(void)
  141          // 描述: P3.2口按键长按1秒触发软件复位，进入USB下载模式。
  142          // 参数: none.
  143          // 返回: none.
  144          // 版本: VER1.0
  145          // 日期: 2022-6-11
  146          // 备注: 
  147          //========================================================================
  148          void KeyResetScan(void)
  149          {
  150   1          if(!P32)
  151   1          {
  152   2              if(!Key_Flag)
  153   2              {
  154   3                  Key_cnt++;
  155   3                  if(Key_cnt >= 1000)         //连续1000ms有效按键检测
  156   3                  {
  157   4                      Key_Flag = 1;           //设置按键状态，防止重复触发
  158   4      
  159   4                      USBCON = 0x00;      //清除USB设置
  160   4                      USBCLK = 0x00;
  161   4                      IRC48MCR = 0x00;
  162   4                      
  163   4                      delay_ms(10);
  164   4                      IAP_CONTR = 0x60;   //触发软件复位，从ISP开始执行
  165   4                      while (1);
  166   4                  }
  167   3              }
  168   2          }
  169   1          else
  170   1          {
  171   2              Key_cnt = 0;
  172   2              Key_Flag = 0;
  173   2          }
  174   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       302     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =         8     ------
  xdata-const size     =    ------     ------
  edata size           =        14     ------
  bit size             =         1     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
C251 COMPILER V5.60.0,  main                                                               09/07/22  14:01:57  PAGE 4   

  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        33     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
