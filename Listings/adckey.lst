C251 COMPILER V5.60.0,  adckey                                                             24/03/23  00:55:25  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE adckey
OBJECT MODULE PLACED IN .\Objects\adckey.obj
COMPILER INVOKED BY: C:\Keil_v5\C251\BIN\C251.EXE Sources\Task\src\adckey.c XSMALL FUNCTIONS(REENTRANT) OPTIMIZE(4,SPEED
                    -) BROWSE INCDIR(.\Sources\User;.\Sources\User\include;.\Sources\FreeRTOS\include;.\Sources\FreeRTOS\portable\STC32G12K12
                    -8;.\Sources\Driver\inc;.\Sources\Task\inc;.\Sources\ch395) DEBUG PRINT(.\Listings\adckey.lst) TABS(2) OBJECT(.\Objects\a
                    -dckey.obj) 

stmt  level    source

    1          /*---------------------------------------------------------------------*/
    2          /* --- STC MCU Limited ------------------------------------------------*/
    3          /* --- STC 1T Series MCU Demo Programme -------------------------------*/
    4          /* --- Mobile: (86)13922805190 ----------------------------------------*/
    5          /* --- Fax: 86-0513-55012956,55012947,55012969 ------------------------*/
    6          /* --- Tel: 86-0513-55012928,55012929,55012966 ------------------------*/
    7          /* --- Web: www.STCMCU.com --------------------------------------------*/
    8          /* --- Web: www.STCMCUDATA.com  ---------------------------------------*/
    9          /* --- QQ:  800003751 -------------------------------------------------*/
   10          /* å¦‚æœè¦åœ¨ç¨‹åºä¸­ä½¿ç”¨æ­¤ä»£ç ,è¯·åœ¨ç¨‹åºä¸­æ³¨æ˜ä½¿ç”¨äº†STCçš„èµ„æ–™åŠç¨‹åº            */
   11          /*---------------------------------------------------------------------*/
   12          
   13          /*************  åŠŸèƒ½è¯´æ˜    **************
   14          
   15          æœ¬ä¾‹ç¨‹åŸºäºSTC32Gä¸ºä¸»æ§èŠ¯ç‰‡çš„å®éªŒç®±è¿›è¡Œç¼–å†™æµ‹è¯•ã€‚
   16          
   17          é€šè¿‡ADCé‡‡é›†æŒ‰é”®å£ADCå€¼ï¼Œæ ¹æ®ADCå€¼è®¾ç½®é”®ç ä¸º1~16.
   18          
   19          æŒ‰é”®åªæ”¯æŒå•é”®æŒ‰ä¸‹, ä¸æ”¯æŒå¤šé”®åŒæ—¶æŒ‰ä¸‹, é‚£æ ·å°†ä¼šæœ‰ä¸å¯é¢„çŸ¥çš„ç»“æœ.
   20          
   21          é”®æŒ‰ä¸‹è¶…è¿‡1ç§’å,å°†ä»¥10é”®/ç§’çš„é€Ÿåº¦æä¾›é‡é”®è¾“å‡º. ç”¨æˆ·åªéœ€è¦æ£€æµ‹KeyCodeæ˜¯å¦é0
             -æ¥åˆ¤æ–­é”®æ˜¯å¦æŒ‰ä¸‹.
   22          
   23          è°ƒæ•´æ—¶é—´é”®:
   24          é”®ç 1: å°æ—¶+.
   25          é”®ç 2: å°æ—¶-.
   26          é”®ç 3: åˆ†é’Ÿ+.
   27          é”®ç 4: åˆ†é’Ÿ-.
   28          
   29          ******************************************/
   30          
   31          #include "FreeRTOS.h"
   32          #include "task.h"
   33          
   34          #include "STC32G_ADC.h"
   35          
   36          #include "adckey.h"
   37          #include "rtc.h"
   38          //#include "display.h"
   39          
   40          #define ADCKEY_CHANNEL          0                       //ADCæŒ‰é”®çš„è¾“å…¥é€šé“ï¼ˆP1.0ï¼‰
   41          #define ADC_OFFSET              64                      //ADCæŒ‰é”®æ‰«ææ—¶çš„åå·®èŒƒå›´
   42          
   43          
   44          static void prvAdcKeyInit( void );
   45          static void prvAdcCalculateKey( void );
   46          static void prvAdcKeyEvent( void );
   47          
   48          
   49          static uint8_t ucKeyState;                              //ADCæŒ‰é”®çŠ¶æ€
   50          static uint8_t ucKeyState1;
   51          static uint8_t ucKeyState2;
   52          static uint8_t ucKeyState3;
   53          static uint8_t ucKeyHoldCnt;                            //é”®æŒ‰ä¸‹è®¡æ—¶
   54          
   55          uint8_t ucKeyCode;                                      //ç»™ç”¨æˆ·ä½¿ç”¨çš„é”®ç , 1~16æœ‰æ•ˆ
C251 COMPILER V5.60.0,  adckey                                                             24/03/23  00:55:25  PAGE 2   

   56          
   57          /* ADCæŒ‰é”®æ‰«æä»»åŠ¡å‡½æ•° */
   58          portTASK_FUNCTION( vAdcKeyTask, pvParameters )
   59          {
   60   1          
   61   1        UNUSED( pvParameters );
   62   1      
   63   1          prvAdcKeyInit();
   64   1          while(1)
   65   1          {
   66   2              prvAdcCalculateKey();
   67   2              prvAdcKeyEvent();
   68   2      
   69   2              vTaskDelay(10);
   70   2          }
   71   1          
   72   1          vTaskDelete(NULL);
   73   1      }   
   74          
   75          static void prvAdcKeyInit( void )
   76          {
   77   1      //    P1M1 |= 0x01;                                       //è®¾ç½® P1.0 ä¸º ADC è¾“å…¥å£
   78   1      //    P1M0 &= ~0x01;
   79   1      
   80   1          ucKeyState  = 0;
   81   1          ucKeyState1 = 0;
   82   1          ucKeyState2 = 0;
   83   1          ucKeyState3 = 0;                                    //é”®çŠ¶æ€
   84   1          ucKeyHoldCnt = 0;                                   //é”®æŒ‰ä¸‹è®¡æ—¶
   85   1          ucKeyCode = 0;                                      //ç»™ç”¨æˆ·ä½¿ç”¨çš„é”®ç , 1~16æœ‰æ•ˆ
   86   1      }
   87          
   88          /***************** ADCé”®ç›˜è®¡ç®—é”®ç  *****************************
   89          ç”µè·¯å’Œè½¯ä»¶ç®—æ³•è®¾è®¡: Coody
   90          æœ¬ADCé”®ç›˜æ–¹æ¡ˆåœ¨å¾ˆå¤šå®é™…äº§å“è®¾è®¡ä¸­, éªŒè¯äº†å…¶ç¨³å®šå¯é , å³ä½¿æŒ‰é”®ä½¿ç”¨å¯¼ç”µè†œ,é
             -ƒ½å¾ˆå¯é .
   91          16ä¸ªé”®,ç†è®ºä¸Šå„ä¸ªé”®å¯¹åº”çš„ADCå€¼ä¸º (4096 / 16) * k = 256 * k, k = 1 ~ 16, ç‰¹åˆ«çš„, k=16æ—¶,å
             -¯¹åº”çš„ADCå€¼æ˜¯4095.
   92          ä½†æ˜¯å®é™…ä¼šæœ‰åå·®,åˆ™åˆ¤æ–­æ—¶é™åˆ¶è¿™ä¸ªåå·®, ADC_OFFSETä¸º+-åå·®, åˆ™ADCå€¼åœ¨ (256*k-ADC_O
             -FFSET) ä¸ (256*k+ADC_OFFSET)ä¹‹é—´ä¸ºé”®æœ‰æ•ˆ.
   93          é—´éš”ä¸€å®šçš„æ—¶é—´,å°±é‡‡æ ·ä¸€æ¬¡ADC,æ¯”å¦‚10ms.
   94          ä¸ºäº†é¿å…å¶ç„¶çš„ADCå€¼è¯¯åˆ¤, æˆ–è€…é¿å…ADCåœ¨ä¸Šå‡æˆ–ä¸‹é™æ—¶è¯¯åˆ¤, ä½¿ç”¨è¿ç»­3æ¬¡ADCå€¼å‡å
             -œ¨åå·®èŒƒå›´å†…æ—¶, ADCå€¼æ‰è®¤ä¸ºæœ‰æ•ˆ.
   95          ä»¥ä¸Šç®—æ³•, èƒ½ä¿è¯è¯»é”®éå¸¸å¯é .
   96          **********************************************/
   97          static void prvAdcCalculateKey( void )
   98          {
   99   1          uint16_t usResult;
  100   1          uint8_t i;
  101   1          uint16_t j;
  102   1          
  103   1          usResult = Get_ADCResult(ADCKEY_CHANNEL);
  104   1          
  105   1          if(usResult < (256 - ADC_OFFSET))
  106   1          {
  107   2              ucKeyState = 0;                                 //é”®çŠ¶æ€å½’0
  108   2              ucKeyHoldCnt = 0;
  109   2          }
  110   1          
  111   1          j = 256;
  112   1          for (i = 1; i <= 16; i++)
  113   1          {
  114   2              if ((usResult >= (j - ADC_OFFSET)) &&
  115   2                  (usResult <= (j + ADC_OFFSET)))
  116   2                 break;                                       //åˆ¤æ–­æ˜¯å¦åœ¨åå·®èŒƒå›´å†…
  117   2              j += 256;
C251 COMPILER V5.60.0,  adckey                                                             24/03/23  00:55:25  PAGE 3   

  118   2          }
  119   1          
  120   1          ucKeyState3 = ucKeyState2;
  121   1          ucKeyState2 = ucKeyState1;
  122   1          
  123   1          if (i > 16)
  124   1              ucKeyState1 = 0;                                //é”®æ— æ•ˆ
  125   1          else                                                //é”®æœ‰æ•ˆ
  126   1          {
  127   2              ucKeyState1 = i;
  128   2              if ((ucKeyState3 == ucKeyState2) &&
  129   2                  (ucKeyState2 == ucKeyState1) &&
  130   2                  (ucKeyState3 > 0) &&
  131   2                  (ucKeyState2 > 0) &&
  132   2                  (ucKeyState1 > 0))
  133   2              {
  134   3                  if (ucKeyState == 0)                        //ç¬¬ä¸€æ¬¡æ£€æµ‹åˆ°
  135   3                  {
  136   4                      ucKeyCode = i;                          //ä¿å­˜é”®ç 
  137   4                      ucKeyState = i;                         //ä¿å­˜é”®çŠ¶æ€
  138   4                      ucKeyHoldCnt = 0;
  139   4                  }
  140   3                  
  141   3                  if (ucKeyState == i)                        //è¿ç»­æ£€æµ‹åˆ°åŒä¸€é”®æŒ‰ç€
  142   3                  {
  143   4                      if (++ucKeyHoldCnt >= 100)              //æŒ‰ä¸‹1ç§’å,ä»¥10æ¬¡æ¯ç§’çš„é€Ÿåº¦Repeat Key
  144   4                      {
  145   5                          ucKeyHoldCnt = 90;
  146   5                          ucKeyCode  = i;                     //ä¿å­˜é”®ç 
  147   5                      }
  148   4                  }
  149   3                  else
  150   3                      ucKeyHoldCnt = 0;                       //æŒ‰ä¸‹æ—¶é—´è®¡æ•°å½’0
  151   3              }
  152   2          }
  153   1      }
  154          
  155          static void prvAdcKeyEvent( void )
  156          {
  157   1          uint8_t ucCode;
  158   1          
  159   1          ucCode = ucKeyCode;
  160   1          ucKeyCode = 0;
  161   1          
  162   1          if (ucCode > 0)                                     //æœ‰é”®æŒ‰ä¸‹
  163   1          {
  164   2      //        pucLEDBuffer[6] = ucCode / 10;                  //æ˜¾ç¤ºé”®ç 
  165   2      //        pucLEDBuffer[7] = ucCode % 10;                  //æ˜¾ç¤ºé”®ç 
  166   2      
  167   2              switch (ucCode)
  168   2              {
  169   3              case 1:                                         //hour +1
  170   3                  if (++ucHour >= 24)
  171   3                      ucHour = 0;
  172   3                  break;
  173   3              case 2:                                         //hour -1
  174   3                  if (--ucHour >= 24)
  175   3                      ucHour = 23;
  176   3                  break;
  177   3              case 3:                                         //minute +1
  178   3                  ucSecond = 0;
  179   3                  if (++ucMinute >= 60)
  180   3                      ucMinute = 0;
  181   3                  break;
  182   3              case 4:                                         //minute -1
  183   3                  ucSecond = 0;
C251 COMPILER V5.60.0,  adckey                                                             24/03/23  00:55:25  PAGE 4   

  184   3                  if (--ucMinute >= 60)
  185   3                      ucMinute = 59;
  186   3                  break;
  187   3              default:
  188   3                  return;
  189   3              }
  190   2              
  191   2              vRtcUpdateDisplay();
  192   2          }
  193   1      }
  194          
  195          


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       370     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =         6     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
